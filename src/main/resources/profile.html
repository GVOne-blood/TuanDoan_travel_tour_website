<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tài Khoản Của Tôi - Tuấn Đoàn Tour</title>

    <!--====== Favicon Icon ======-->
    <link rel="shortcut icon" href="assets/images/logo/logo-8.png" type="image/png" />
    <!-- ===== All CSS files ===== -->
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/animate.css" />
    <link rel="stylesheet" href="assets/css/lineicons.css" />
    <link rel="stylesheet" href="assets/css/ud-styles.css" />
    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/58d4e782be.js" crossorigin="anonymous"></script>

    <!-- Custom CSS for Profile Page -->
    <style>
        .profile-container { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 40px; }
        .profile-sidebar { flex: 0 0 280px; }
        .profile-avatar { width: 280px; height: 280px; border-radius: 50%; border: 5px solid #f1f1f1; object-fit: cover; }
        .profile-sidebar h2 { font-size: 1.8rem; font-weight: 600; margin-top: 20px; margin-bottom: 5px; }
        .profile-sidebar p { font-size: 1.2rem; color: #6c757d; margin-bottom: 20px; }
        .profile-main { flex-grow: 1; min-width: 0; }

        /* Calendar Styles - HOÀN TOÀN MỚI */
        .calendar-wrapper { border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; background-color: #fff; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-header h5 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .year-nav-btn { background: none; border: 1px solid #ccc; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .year-nav-btn:hover { background-color: #f1f1f1; }

        .month-card { border: 1px solid #f0f0f0; border-radius: 6px; padding: 15px; animation: pop-in 0.5s ease-out forwards; opacity: 0; }
        .month-title { font-weight: 500; font-size: 0.9rem; margin-bottom: 10px; text-align: center; }
        .day-header-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell { width: 100%; aspect-ratio: 1 / 1; background-color: #ebedf0; border-radius: 3px; transition: all 0.2s ease-in-out; }
        .day-cell:hover { transform: scale(1.2); z-index: 1; position: relative; }
        .day-cell[data-level="1"] { background-color: #9be9a8; }
        .day-cell[data-level="2"] { background-color: #40c463; }
        .day-cell[data-level="3"] { background-color: #30a14e; }
        .day-cell[data-level="4"] { background-color: #216e39; }

        /* Edit Form Styles */
        #edit-profile-form-section { display: none; margin-top: 40px; padding: 30px; border: 1px solid #ddd; border-radius: 8px; background-color: #f8f9fa; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* Animation */
        @keyframes pop-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
<!-- ====== Header Start ====== -->
<div id="header-placeholder"></div>
<!-- ====== Header End ====== -->

<!-- ====== Banner Start ====== -->
<section class="ud-page-banner">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="ud-banner-content">
                    <h1>Tài Khoản Của Tôi</h1>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- ====== Banner End ====== -->

<!-- ====== Profile Section Start ====== -->
<section id="profile-section" class="py-5">
    <div class="container">
        <div class="profile-container">
            <div class="profile-sidebar fade-in">
                <img id="profile-avatar" src="assets/images/team/default-avatar.png" alt="User Avatar" class="profile-avatar">
                <h2 id="profile-fullname">Đang tải...</h2>
                <p id="profile-username">@username</p>
                <button id="edit-profile-btn" class="ud-main-btn w-100">Chỉnh sửa thông tin</button>
            </div>
            <div class="profile-main">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button id="prev-year-btn" class="year-nav-btn"><</button>
                        <h5 id="calendar-year-display">Năm 2024</h5>
                        <button id="next-year-btn" class="year-nav-btn">></button>
                    </div>
                    <div id="calendar-container" class="row g-3">
                        <!-- 12 tháng sẽ được render ở đây -->
                    </div>
                </div>
            </div>
        </div>

        <div id="edit-profile-form-section">
            <h3>Thông tin cá nhân</h3>
            <hr>
            <form id="profile-form">
                <div class="row">
                    <div class="col-md-6 mb-3"><label for="form-fullname" class="form-label">Họ và tên</label><input type="text" class="form-control" id="form-fullname" required></div>
                    <div class="col-md-6 mb-3"><label for="form-username" class="form-label">Tên người dùng (Không thể thay đổi)</label><input type="text" class="form-control" id="form-username" readonly disabled></div>
                    <div class="col-md-6 mb-3"><label for="form-email" class="form-label">Email</label><input type="email" class="form-control" id="form-email" required></div>
                    <div class="col-md-6 mb-3"><label for="form-phone" class="form-label">Số điện thoại</label><input type="tel" class="form-control" id="form-phone"></div>
                    <div class="col-12 mb-3"><label for="form-address" class="form-label">Địa chỉ</label><input type="text" class="form-control" id="form-address"></div>
                    <div class="col-md-6 mb-3"><label for="form-gender" class="form-label">Giới tính</label><select id="form-gender" class="form-select"><option value="MALE">Nam</option><option value="FEMALE">Nữ</option><option value="OTHER">Khác</option></select></div>
                </div>
                <div class="mt-3"><button type="submit" class="ud-main-btn">Lưu thay đổi</button><button type="button" id="cancel-btn" class="ud-main-btn ud-white-btn">Hủy</button></div>
            </form>
        </div>
    </div>
</section>
<!-- ====== Profile Section End ====== -->

<!-- ====== Footer Start ====== -->
<div id="footer-placeholder"></div>
<!-- ====== Footer End ====== -->

<a href="javascript:void(0)" class="back-to-top"><i class="lni lni-chevron-up"></i></a>

<!-- ====== All Javascript Files ====== -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="assets/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/wow.min.js"></script>
<script src="assets/js/main.js"></script>
<script src="assets/js/include.js"></script>

<script>
    $(document).ready(function() {
        const userId = localStorage.getItem('userId');
        if (!userId) {
            window.location.href = 'login.html';
            return;
        }

        let allTourDates = {};
        let currentYear = new Date().getFullYear();

        fetchUserData(userId);
        fetchContributionData();
        attachEventListeners();

        function attachEventListeners() {
            $('#edit-profile-btn').on('click', () => $('#edit-profile-form-section').slideToggle());
            $('#cancel-btn').on('click', () => $('#edit-profile-form-section').slideUp());
            $('#profile-form').on('submit', (e) => handleFormSubmit(e, userId));

            $('#prev-year-btn').on('click', function() {
                currentYear--;
                updateCalendarView();
            });
            $('#next-year-btn').on('click', function() {
                currentYear++;
                updateCalendarView();
            });
        }

        function updateCalendarView() {
            $('#calendar-year-display').text(`Năm ${currentYear}`);
            renderContributionCalendar(allTourDates, currentYear);
        }

        function fetchUserData(id) {
            $.ajax({ url: `http://localhost:8085/api/user/${id}`, type: 'GET' })
                .done(res => res.data && (renderUserProfile(res.data), renderEditForm(res.data)))
                .fail(err => err.status !== 401 && alert('Lỗi tải thông tin người dùng.'));
        }

        function fetchContributionData() {
            $.ajax({ url: 'http://localhost:8085/api/tour/getAllTourUser', type: 'GET' })
                .done(res => {
                    if (res.data) {
                        allTourDates = processContributionData(res.data);
                        updateCalendarView();
                    }
                });
        }

        function handleFormSubmit(event, id) {
            event.preventDefault();
            const updateUserDTO = {
                fullname: $('#form-fullname').val(),
                email: $('#form-email').val(),
                phone: $('#form-phone').val(),
                address: $('#form-address').val(),
                gender: $('#form-gender').val()
            };
            const $submitBtn = $('#profile-form button[type="submit"]');
            $submitBtn.prop('disabled', true).text('Đang lưu...');
            $.ajax({
                url: `http://localhost:8085/api/user/update/${id}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(updateUserDTO)
            }).done(res => {
                alert('Cập nhật thành công!');
                res.data && renderUserProfile(res.data);
                $('#edit-profile-form-section').slideUp();
            }).fail(err => err.status !== 401 && alert('Lỗi: ' + (err.responseJSON?.message || 'Không thể cập nhật.')))
                .always(() => $submitBtn.prop('disabled', false).text('Lưu thay đổi'));
        }

        function renderUserProfile(user) {
            $('#profile-fullname').text(user.fullname || 'Chưa có tên');
            $('#profile-username').text('@' + user.username);
        }

        function renderEditForm(user) {
            $('#form-fullname').val(user.fullname || '');
            $('#form-username').val(user.username || '');
            $('#form-email').val(user.email || '');
            $('#form-phone').val(user.phone || '');
            $('#form-address').val(user.address || '');
            $('#form-gender').val(user.gender || 'MALE');
        }

        function processContributionData(tourStarts) {
            const dateCounts = {};
            tourStarts.forEach(tour => {
                const date = new Date(tour.departing_at).toISOString().split('T')[0];
                dateCounts[date] = (dateCounts[date] || 0) + 1;
            });
            return dateCounts;
        }

        function renderContributionCalendar(dateCounts, year) {
            const container = $('#calendar-container');
            container.empty();
            const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
            const dayHeaders = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];

            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let startingDay = firstDay.getDay(); // Sunday = 0, Monday = 1
                startingDay = (startingDay === 0) ? 6 : startingDay - 1; // Monday = 0

                let cells = '';
                for (let i = 0; i < startingDay; i++) {
                    cells += '<div class="day-cell" style="background: transparent; animation: none;"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const d = new Date(year, month, day);
                    const dateString = d.toISOString().split('T')[0];
                    const count = dateCounts[dateString] || 0;
                    let level = 0;
                    if (count > 0) level = 1; if (count > 2) level = 2; if (count > 5) level = 3; if (count > 8) level = 4;
                    const tooltipText = count > 0 ? `${count} tour khởi hành` : `Không có hoạt động`;
                    cells += `<div class="day-cell" data-level="${level}" data-bs-toggle="tooltip" title="${tooltipText} ngày ${d.toLocaleDateString('vi-VN')}"></div>`;
                }

                const monthCardHtml = `
                        <div class="col-lg-4 col-md-6">
                            <div class="month-card" style="animation-delay: ${month * 50}ms">
                                <h6 class="month-title">${monthNames[month]}</h6>
                                <div class="day-header-grid">${dayHeaders.map(h => `<div>${h}</div>`).join('')}</div>
                                <div class="month-grid">${cells}</div>
                            </div>
                        </div>
                    `;
                container.append(monthCardHtml);
            }

            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
    });
</script>
</body>
</html>